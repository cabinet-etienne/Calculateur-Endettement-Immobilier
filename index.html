<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Simulateur crÃ©dit immobilier</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOKENS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --ink:        #0f1923;
  --ink-soft:   #3d4f5e;
  --ink-muted:  #7a8e9a;
  --surface:    #f4f1eb;
  --card:       #ffffff;
  --border:     #ddd8ce;
  --border-s:   #eee9e0;
  --red:        #c0392b;
  --amber:      #d97706;
  --green:      #16a34a;
  --blue:       #2563eb;
  --red-bg:     #fdecea;
  --amber-bg:   #fef3e2;
  --green-bg:   #dcfce7;
  --blue-bg:    #eff6ff;
  --shadow:     0 2px 16px rgba(15,25,35,.07);
  --radius:     4px;
  --radius-lg:  12px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESET
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:'DM Sans',sans-serif;background:var(--surface);color:var(--ink);font-size:14px;line-height:1.5}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEADER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.site-header{background:var(--ink);color:#fff;padding:32px 24px;position:relative;overflow:hidden}
.site-header::before{content:'';position:absolute;right:-80px;top:-80px;width:340px;height:340px;border-radius:50%;background:rgba(192,57,43,.12);pointer-events:none}
.site-header::after{content:'';position:absolute;right:80px;bottom:-50px;width:200px;height:200px;border-radius:50%;background:rgba(217,119,6,.09);pointer-events:none}
.header-inner{max-width:1200px;margin:0 auto;display:flex;align-items:flex-end;justify-content:space-between;gap:24px;flex-wrap:wrap;position:relative;z-index:1}
.eyebrow{font-size:11px;font-weight:600;letter-spacing:3px;text-transform:uppercase;color:#d97706;margin-bottom:8px}
.site-header h1{font-family:'DM Serif Display',serif;font-size:clamp(22px,3.5vw,38px);font-weight:400;line-height:1.15;color:#fff}
.site-header h1 em{font-style:italic;color:#e9c99a}
.header-sub{color:rgba(255,255,255,.5);font-size:13px;margin-top:6px}
.header-badge{font-size:11px;line-height:1.5;background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.14);border-radius:8px;padding:10px 14px;color:rgba(255,255,255,.5);max-width:320px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LAYOUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.main{max-width:1200px;margin:0 auto;padding:28px 20px 60px}
.layout{display:grid;grid-template-columns:420px 1fr;gap:20px;align-items:start}
@media(max-width:960px){.layout{grid-template-columns:1fr}}
.col-inputs,.col-results{display:flex;flex-direction:column;gap:16px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CARDS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.card{background:var(--card);border-radius:var(--radius-lg);box-shadow:var(--shadow);overflow:hidden;animation:fadeUp .35s ease both}
.card:nth-child(2){animation-delay:.05s}
.card:nth-child(3){animation-delay:.10s}
.card:nth-child(4){animation-delay:.15s}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.card-head{display:flex;align-items:center;gap:10px;padding:16px 20px 13px;border-bottom:1px solid var(--border)}
.card-icon{width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.ci-red{background:var(--red-bg)} .ci-amber{background:var(--amber-bg)} .ci-green{background:var(--green-bg)} .ci-blue{background:var(--blue-bg)}
.card-title{font-size:12px;font-weight:600;letter-spacing:.5px;text-transform:uppercase;color:var(--ink-soft)}
.card-body{padding:18px 20px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FORM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.field{margin-bottom:14px}
.field:last-child{margin-bottom:0}
.field-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px}
@media(max-width:540px){.field-row{grid-template-columns:1fr}}
label{display:block;margin-bottom:6px;font-size:12px;font-weight:600;letter-spacing:.3px;text-transform:uppercase;color:var(--ink-muted)}
.hint{font-size:11px;color:var(--ink-muted);line-height:1.4;margin-top:5px;font-style:italic}
.sub-title{font-size:12px;font-weight:600;letter-spacing:.5px;text-transform:uppercase;color:var(--ink-soft);margin-bottom:12px}
.sep{border:none;border-top:1px solid var(--border-s);margin:16px 0}

/* Input â‚¬*/
.input-wrap{display:flex;align-items:center;border:1.5px solid var(--border);border-radius:var(--radius);overflow:hidden;background:#fff;transition:border-color .15s}
.input-wrap:focus-within{border-color:var(--ink)}
.input-wrap input{flex:1;border:none;outline:none;padding:9px 10px;font-family:'DM Sans',sans-serif;font-size:14px;font-weight:500;color:var(--ink);background:transparent;-moz-appearance:textfield}
.input-wrap input::-webkit-outer-spin-button,.input-wrap input::-webkit-inner-spin-button{-webkit-appearance:none}
.suffix-eur::after{content:'â‚¬';padding:9px 10px 9px 0;color:var(--ink-muted);font-size:12px}

/* Select */
select{width:100%;padding:9px 10px;border:1.5px solid var(--border);border-radius:var(--radius);font-family:'DM Sans',sans-serif;font-size:13px;color:var(--ink);background:#fff;appearance:none;cursor:pointer;transition:border-color .15s}
select:focus{outline:none;border-color:var(--ink)}

/* Slider */
.slider-row{display:flex;align-items:center;gap:10px}
.slider-row input[type="range"]{flex:1;min-width:0}
.slider-num{display:flex;align-items:center;gap:4px;flex-shrink:0}
.slider-num input{width:56px;padding:6px;text-align:right;border:1.5px solid var(--border);border-radius:var(--radius);font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;color:var(--ink);background:#fff;-moz-appearance:textfield;outline:none;transition:border-color .15s}
.slider-num input::-webkit-outer-spin-button,.slider-num input::-webkit-inner-spin-button{-webkit-appearance:none}
.slider-num input:focus{border-color:var(--ink)}
.slider-num span{font-size:12px;color:var(--ink-muted)}
input[type="range"]{-webkit-appearance:none;height:4px;background:var(--border);border-radius:2px;cursor:pointer}
input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:15px;height:15px;border-radius:50%;background:var(--ink);border:2px solid #fff;box-shadow:0 1px 4px rgba(0,0,0,.2)}
input[type="range"]::-moz-range-thumb{width:15px;height:15px;border-radius:50%;background:var(--ink);border:2px solid #fff;box-shadow:0 1px 4px rgba(0,0,0,.2);cursor:pointer}

/* Checkbox */
.field-check{display:flex;flex-direction:column;justify-content:center}
.check-label{display:flex;align-items:flex-start;gap:8px;cursor:pointer;text-transform:none;letter-spacing:0;font-size:13px;font-weight:500;color:var(--ink-soft)}
.check-label input[type="checkbox"]{margin-top:2px;flex-shrink:0;width:15px;height:15px;cursor:pointer}

/* Toggle buttons */
.toggle-group{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px}
.tog-btn{padding:5px 12px;border-radius:20px;border:1.5px solid var(--border);background:#fff;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:500;cursor:pointer;color:var(--ink-soft);transition:all .15s}
.tog-btn.active,.tog-btn:hover{background:var(--ink);color:#fff;border-color:var(--ink)}

/* Rental method box */
.rental-box{background:var(--surface);border-radius:8px;padding:12px;border:1px solid var(--border-s)}
.method-diff-note{font-style:normal !important}

.badge{font-size:10px;padding:1px 6px;border-radius:10px;background:var(--blue-bg);color:var(--blue);font-weight:600;margin-left:4px;text-transform:none;letter-spacing:0}
.hidden{display:none !important}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   KPIs
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.kpi-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:16px}
@media(max-width:540px){.kpi-grid{grid-template-columns:1fr}}
.kpi{padding:14px 16px;border-radius:8px;border:1.5px solid var(--border);transition:border-color .25s}
.kpi-label{font-size:10px;font-weight:600;letter-spacing:1px;text-transform:uppercase;color:var(--ink-muted);margin-bottom:6px}
.kpi-value{font-family:'DM Serif Display',serif;font-size:22px;line-height:1;color:var(--ink);transition:color .25s}
.kpi-sub{font-size:11px;color:var(--ink-muted);margin-top:5px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BANNER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.banner{padding:13px 16px;border-radius:8px;font-size:13px;font-weight:600;border:2px solid var(--border);background:var(--surface);margin-bottom:16px;transition:all .25s;line-height:1.4}
.banner.ok  {background:var(--green-bg);border-color:var(--green);color:#14532d}
.banner.warn{background:var(--amber-bg);border-color:var(--amber);color:#78350f}
.banner.bad {background:var(--red-bg);  border-color:var(--red);  color:#7f1d1d}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DETAIL TABLE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.detail-table{width:100%;border-collapse:collapse;margin-bottom:12px}
.detail-table td{padding:8px 2px;font-size:13px;border-bottom:1px solid var(--border-s)}
.detail-table td:first-child{color:var(--ink-soft)}
.detail-table td:last-child{text-align:right;font-weight:600;color:var(--ink)}
.detail-table .row-total td{border-top:2px solid var(--border);padding-top:10px;padding-bottom:10px}
.detail-table .row-sep td{border-top:2px solid var(--border);padding-top:10px}
.detail-table .hint-cell{font-size:11px;color:var(--ink-muted);padding-left:12px}
.taeg-note{font-size:11px;color:var(--ink-muted);line-height:1.5;font-style:italic;margin-bottom:12px}

/* Alerts */
#alertZone{display:flex;flex-direction:column;gap:8px}
.alert-box{display:flex;gap:10px;align-items:flex-start;padding:10px 14px;border-radius:6px;font-size:12px;line-height:1.45}
.alert-box.warn{background:var(--amber-bg);color:#78350f;border:1px solid #f0c06e}
.alert-box.bad {background:var(--red-bg);  color:#7f1d1d;border:1px solid #f3a9a2}
.alert-box .ai{flex-shrink:0;margin-top:1px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHARTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.chart-wrap{position:relative}
.chart-note{text-align:center;font-size:11px;color:var(--ink-muted);margin-top:8px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AMORTISSEMENT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.amort-controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
.amort-btn{padding:5px 14px;border-radius:20px;border:1.5px solid var(--border);background:#fff;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:500;cursor:pointer;color:var(--ink-soft);transition:all .15s}
.amort-btn.active,.amort-btn:not(.ghost):hover{background:var(--ink);color:#fff;border-color:var(--ink)}
.amort-btn.ghost{color:var(--ink-muted)}
.amort-btn.ghost:hover{background:var(--surface);border-color:var(--ink-soft)}
.amort-wrap{max-height:340px;overflow-y:auto;border-radius:6px;border:1px solid var(--border)}
#amortTable{width:100%;border-collapse:collapse;font-size:12px}
#amortTable thead th{position:sticky;top:0;background:var(--ink);color:#fff;padding:9px 10px;text-align:right;font-size:10px;font-weight:500;letter-spacing:.5px;text-transform:uppercase}
#amortTable thead th:first-child{text-align:left}
#amortTable tbody tr{border-bottom:1px solid var(--border-s)}
#amortTable tbody tr:hover{background:#fafaf7}
#amortTable tbody td{padding:7px 10px;text-align:right;color:var(--ink-soft)}
#amortTable tbody td:first-child{text-align:left;color:var(--ink);font-weight:500}
#amortTable tbody tr.year-row td{background:var(--surface);font-weight:600;color:var(--ink);border-top:1px solid var(--border)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FOOTER LÃ‰GAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.legal-footer{margin-top:32px;padding:20px 24px;background:var(--card);border-radius:var(--radius-lg);border:1px solid var(--border);font-size:12px;color:var(--ink-muted);line-height:1.7}
.legal-footer strong{color:var(--ink-soft)}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•  HEADER  â•â•â•â•â•â•â•â•â•â• -->
<header class="site-header">
  <div class="header-inner">
    <div>
      <p class="eyebrow">Outil de simulation</p>
      <h1>Simulateur de crÃ©dit <em>immobilier</em></h1>
      <p class="header-sub">MensualitÃ© Â· Endettement Â· TAEG estimatif Â· Tableau d'amortissement</p>
    </div>
    <div class="header-badge">
      âš  Simulation indicative â€” rÃ©sultats non contractuels.<br>
      Ne constitue pas une offre de crÃ©dit ni un conseil financier.
    </div>
  </div>
</header>

<!-- â•â•â•â•â•â•â•â•â•â•  MAIN  â•â•â•â•â•â•â•â•â•â• -->
<main class="main">
<div class="layout">

<!-- â•â•â•â•â•â•â•â•  INPUTS  â•â•â•â•â•â•â•â• -->
<div class="col-inputs">

  <!-- Projet -->
  <section class="card">
    <div class="card-head"><span class="card-icon ci-red">ğŸ </span><span class="card-title">Projet immobilier</span></div>
    <div class="card-body">

      <div class="field">
        <label for="propertyPrice">Prix du bien (hors frais)</label>
        <div class="input-wrap suffix-eur"><input id="propertyPrice" type="number" min="0" value="275000" step="1000"></div>
        <p class="hint">Prix affichÃ©, hors frais de notaire, d'agence et travaux.</p>
      </div>

      <div class="field-row">
        <div class="field">
          <label for="agencyFees">Frais d'agence</label>
          <div class="input-wrap suffix-eur"><input id="agencyFees" type="number" min="0" value="0" step="100"></div>
        </div>
        <div class="field">
          <label for="works">Travaux</label>
          <div class="input-wrap suffix-eur"><input id="works" type="number" min="0" value="0" step="500"></div>
        </div>
      </div>

      <div class="field">
        <label>Frais de notaire</label>
        <div class="toggle-group">
          <button class="tog-btn active" id="btnAnc">Ancien (~7.5%)</button>
          <button class="tog-btn" id="btnNeuf">Neuf (~2.5%)</button>
          <button class="tog-btn" id="btnMontant">Montant fixe</button>
        </div>
        <div id="notaryRateWrap">
          <div class="slider-row">
            <input type="range" id="notaryRate" min="1" max="12" step="0.1" value="7.5">
            <div class="slider-num"><input type="number" id="notaryRateNum" min="1" max="12" step="0.1" value="7.5"><span>%</span></div>
          </div>
          <p class="hint" id="notaryEstimate">â€”</p>
        </div>
        <div id="notaryAmountWrap" class="hidden">
          <div class="input-wrap suffix-eur"><input id="notaryAmount" type="number" min="0" step="100" value="20000"></div>
        </div>
      </div>

      <div class="field">
        <label for="downPayment">Apport total disponible</label>
        <div class="input-wrap suffix-eur"><input id="downPayment" type="number" min="0" value="55000" step="500"></div>
        <p class="hint" id="downHint">L'apport doit couvrir en prioritÃ© les frais de notaire et les frais de crÃ©dit.</p>
      </div>

    </div>
  </section>

  <!-- CrÃ©dit -->
  <section class="card">
    <div class="card-head"><span class="card-icon ci-amber">ğŸ“Š</span><span class="card-title">ParamÃ¨tres du crÃ©dit</span></div>
    <div class="card-body">

      <div class="field">
        <label>DurÃ©e du prÃªt</label>
        <div class="slider-row">
          <input type="range" id="loanYears" min="5" max="25" step="1" value="20">
          <div class="slider-num"><input type="number" id="loanYearsNum" min="5" max="25" step="1" value="20"><span>ans</span></div>
        </div>
        <p class="hint">DurÃ©e max rÃ©glementaire : 25 ans (27 ans en VEFA selon HCSF 2021).</p>
      </div>

      <div class="field">
        <label>Taux d'intÃ©rÃªt nominal annuel</label>
        <div class="slider-row">
          <input type="range" id="interestRate" min="0.10" max="8.00" step="0.01" value="3.50">
          <div class="slider-num"><input type="number" id="interestRateNum" min="0.10" max="12" step="0.01" value="3.50"><span>%</span></div>
        </div>
      </div>

      <div class="field-row">
        <div class="field">
          <label>Assurance emprunteur (annuelle)</label>
          <div class="slider-row">
            <input type="range" id="insuranceRate" min="0" max="1.50" step="0.01" value="0.35">
            <div class="slider-num"><input type="number" id="insuranceRateNum" min="0" max="3" step="0.01" value="0.35"><span>%</span></div>
          </div>
        </div>
        <div class="field">
          <label for="insuranceMode">Base de calcul assurance</label>
          <select id="insuranceMode">
            <option value="initial" selected>Capital initial (constante)</option>
            <option value="outstanding">Capital restant dÃ» (dÃ©croissante)</option>
          </select>
          <p class="hint">Sur CRD = moins cher sur la durÃ©e, flux non constants.</p>
        </div>
      </div>

      <hr class="sep">
      <p class="sub-title">Frais de crÃ©dit</p>

      <div class="field-row">
        <div class="field">
          <label for="fileFees">Frais de dossier</label>
          <div class="input-wrap suffix-eur"><input id="fileFees" type="number" min="0" value="1000" step="50"></div>
        </div>
        <div class="field">
          <label>Frais de garantie <span class="badge">% du capital</span></label>
          <div class="slider-row">
            <input type="range" id="guaranteeRate" min="0.5" max="2.5" step="0.1" value="1.2">
            <div class="slider-num"><input type="number" id="guaranteeRateNum" min="0.5" max="2.5" step="0.1" value="1.2"><span>%</span></div>
          </div>
          <p class="hint">Caution type CrÃ©dit Logement â‰ˆ 1â€“1.5%</p>
        </div>
      </div>

      <div class="field-row">
        <div class="field">
          <label for="brokerFees">Frais de courtage</label>
          <div class="input-wrap suffix-eur"><input id="brokerFees" type="number" min="0" value="0" step="50"></div>
        </div>
        <div class="field field-check">
          <label class="check-label" for="financeLoanFees">
            <input id="financeLoanFees" type="checkbox">
            IntÃ©grer les frais de crÃ©dit dans le prÃªt
          </label>
          <p class="hint">Sinon ils sont couverts par l'apport.</p>
        </div>
      </div>

    </div>
  </section>

  <!-- Revenus -->
  <section class="card">
    <div class="card-head"><span class="card-icon ci-green">ğŸ’¶</span><span class="card-title">Revenus & charges</span></div>
    <div class="card-body">

      <div class="field-row">
        <div class="field">
          <label for="income1">Revenu principal net mensuel</label>
          <div class="input-wrap suffix-eur"><input id="income1" type="number" min="0" value="4500" step="50"></div>
          <p class="hint">Pris Ã  100%</p>
        </div>
        <div class="field">
          <label for="income2">Revenu co-emprunteur net mensuel</label>
          <div class="input-wrap suffix-eur"><input id="income2" type="number" min="0" value="0" step="50"></div>
          <p class="hint">Pris Ã  100%</p>
        </div>
      </div>

      <div class="field">
        <label>Revenus fonciers nets mensuels</label>
        <div class="input-wrap suffix-eur" style="margin-bottom:10px">
          <input id="rentalIncome" type="number" min="0" value="0" step="50">
        </div>
        <div class="rental-box">
          <div class="toggle-group" style="margin-bottom:8px">
            <button class="tog-btn active" id="methodClassic">MÃ©thode classique</button>
            <button class="tog-btn" id="methodDiff">MÃ©thode diffÃ©rentielle</button>
          </div>
          <div id="methodClassicInfo">
            <div class="slider-row">
              <input type="range" id="rentalFactor" min="0" max="100" step="1" value="70">
              <div class="slider-num"><input type="number" id="rentalFactorNum" min="0" max="100" step="1" value="70"><span>%</span></div>
            </div>
            <p class="hint">Pourcentage des loyers retenu par la banque. Taux courant : 70%. Varie selon Ã©tablissement et profil.</p>
          </div>
          <div id="methodDiffInfo" class="hidden">
            <p class="hint method-diff-note">MÃ©thode diffÃ©rentielle : les loyers sont dÃ©duits des charges de crÃ©dit existantes avant calcul du taux d'endettement. Revenus fonciers pris Ã  100%. Certaines banques l'appliquent pour les investisseurs. VÃ©rifiez la mÃ©thode retenue par votre Ã©tablissement.</p>
          </div>
        </div>
      </div>

      <hr class="sep">

      <div class="field-row">
        <div class="field">
          <label for="existingCharges">Charges mensuelles existantes</label>
          <div class="input-wrap suffix-eur"><input id="existingCharges" type="number" min="0" value="0" step="50"></div>
          <p class="hint">CrÃ©dits conso, auto, pensions, loyer actuel.</p>
        </div>
        <div class="field">
          <label>Seuil d'endettement cible</label>
          <div class="slider-row">
            <input type="range" id="debtCap" min="20" max="45" step="0.5" value="35">
            <div class="slider-num"><input type="number" id="debtCapNum" min="20" max="45" step="0.5" value="35"><span>%</span></div>
          </div>
          <p class="hint">HCSF 2021 : 35% max. DÃ©rogations possibles selon profil.</p>
        </div>
      </div>

    </div>
  </section>

</div><!-- /col-inputs -->

<!-- â•â•â•â•â•â•â•â•  RÃ‰SULTATS  â•â•â•â•â•â•â•â• -->
<div class="col-results">

  <!-- KPIs + dÃ©tail -->
  <section class="card">
    <div class="card-head"><span class="card-icon ci-red">ğŸ’°</span><span class="card-title">RÃ©sultats</span></div>
    <div class="card-body">

      <div class="kpi-grid">
        <div class="kpi">
          <div class="kpi-label">MensualitÃ© (mois 1)</div>
          <div class="kpi-value" id="kpiMonthly">â€”</div>
          <div class="kpi-sub" id="kpiMonthlySplit">â€”</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Taux d'endettement</div>
          <div class="kpi-value" id="kpiDebt">â€”</div>
          <div class="kpi-sub" id="kpiCapacity">Seuil cible : 35%</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Budget total d'acquisition</div>
          <div class="kpi-value" id="kpiBudget">â€”</div>
          <div class="kpi-sub">Prix + notaire + agence + travaux</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Capital empruntÃ©</div>
          <div class="kpi-value" id="kpiLoan">â€”</div>
          <div class="kpi-sub" id="kpiLoanNote">â€”</div>
        </div>
      </div>

      <div class="banner" id="banner">â€”</div>

      <table class="detail-table">
        <tbody>
          <tr><td>Prix du bien</td><td id="dProperty">â€”</td></tr>
          <tr><td>Frais de notaire estimÃ©s</td><td id="dNotary">â€”</td></tr>
          <tr><td>Frais d'agence + travaux</td><td id="dExtras">â€”</td></tr>
          <tr class="row-total"><td><strong>Budget total d'acquisition</strong></td><td id="dBudget"><strong>â€”</strong></td></tr>
          <tr><td>Apport total</td><td id="dDown">â€”</td></tr>
          <tr><td>Frais de crÃ©dit (dossier + garantie + courtage)</td><td id="dLoanFees">â€”</td></tr>
          <tr><td class="hint-cell">â†’ dont financÃ©s dans le prÃªt</td><td id="dFeesFinanced">â€”</td></tr>
          <tr class="row-total"><td><strong>Capital empruntÃ©</strong></td><td id="dLoan"><strong>â€”</strong></td></tr>
          <tr><td>IntÃ©rÃªts totaux</td><td id="dInterest">â€”</td></tr>
          <tr><td>Assurance totale</td><td id="dInsurance">â€”</td></tr>
          <tr><td>CoÃ»t total du crÃ©dit</td><td id="dCreditCost">â€”</td></tr>
          <tr><td>Total remboursÃ©</td><td id="dTotalPaid">â€”</td></tr>
          <tr class="row-sep"><td>TAEG estimatif (hors frais d'acquisition)</td><td id="dTaeg">â€”</td></tr>
          <tr><td>Apport minimum conseillÃ©</td><td id="dMinDown">â€”</td></tr>
          <tr><td>Reste Ã  vivre estimÃ© / mois</td><td id="dRav">â€”</td></tr>
          <tr><td>CapacitÃ© d'emprunt restante</td><td id="dCapacity">â€”</td></tr>
        </tbody>
      </table>

      <p class="taeg-note">TAEG calculÃ© sur les flux rÃ©els mensuels (IRR), assurance incluse, frais de crÃ©dit dÃ©duits du capital net reÃ§u Ã  t=0. Hors frais d'acquisition (notaire, agence, travaux) qui ne sont pas des coÃ»ts du crÃ©dit au sens rÃ©glementaire. Valeur indicative, non contractuelle.</p>

      <div id="alertZone"></div>

    </div>
  </section>

  <!-- Bar chart -->
  <section class="card">
    <div class="card-head"><span class="card-icon ci-amber">ğŸ“ˆ</span><span class="card-title">RÃ©partition du coÃ»t total</span></div>
    <div class="card-body">
      <div class="chart-wrap" style="height:200px"><canvas id="chartBar"></canvas></div>
      <p class="chart-note">Capital remboursÃ© Â· IntÃ©rÃªts Â· Assurance Â· Frais de crÃ©dit</p>
    </div>
  </section>

  <!-- Line chart -->
  <section class="card">
    <div class="card-head"><span class="card-icon ci-green">ğŸ“‰</span><span class="card-title">Capital restant dÃ» dans le temps</span></div>
    <div class="card-body">
      <div class="chart-wrap" style="height:220px"><canvas id="chartLine"></canvas></div>
      <p class="chart-note">Rouge = capital restant dÃ» Â· Vert = capital remboursÃ© cumulÃ©</p>
    </div>
  </section>

  <!-- Amortissement -->
  <section class="card">
    <div class="card-head"><span class="card-icon ci-blue">ğŸ—‚</span><span class="card-title">Tableau d'amortissement</span></div>
    <div class="card-body">
      <div class="amort-controls">
        <button class="amort-btn active" id="btnAnnuel">Vue annuelle</button>
        <button class="amort-btn" id="btnMensuel">Vue mensuelle</button>
        <button class="amort-btn ghost" id="btnCsv">â¬‡ Exporter CSV</button>
      </div>
      <div class="amort-wrap">
        <table id="amortTable">
          <thead>
            <tr>
              <th>PÃ©riode</th><th>MensualitÃ©</th><th>Capital</th>
              <th>IntÃ©rÃªts</th><th>Assurance</th><th>Capital restant</th>
            </tr>
          </thead>
          <tbody id="amortBody"></tbody>
        </table>
      </div>
    </div>
  </section>

</div><!-- /col-results -->
</div><!-- /layout -->

<!-- Footer lÃ©gal -->
<footer class="legal-footer">
  <strong>Avertissement lÃ©gal :</strong> Cet outil est fourni Ã  titre strictement indicatif et ne constitue ni une offre de crÃ©dit, ni un conseil financier, ni une garantie d'obtention d'un prÃªt. Les rÃ©sultats reposent sur des hypothÃ¨ses simplifiÃ©es (taux fixe, frais estimatifs, revenus dÃ©clarÃ©s non vÃ©rifiÃ©s) et peuvent diffÃ©rer significativement des conditions appliquÃ©es par un Ã©tablissement prÃªteur.
  <br><br>
  Le <strong>TAEG rÃ©glementaire officiel</strong> vous sera communiquÃ© par votre banque dans la fiche d'information standardisÃ©e europÃ©enne (FISE), conformÃ©ment Ã  la directive crÃ©dit immobilier 2014/17/UE. Consultez un professionnel du crÃ©dit (courtier agrÃ©Ã© ORIAS, conseiller bancaire) avant toute dÃ©cision d'investissement.
  <br><br>
  <strong>Revenus fonciers :</strong> La mÃ©thode de prise en compte varie selon les Ã©tablissements et les profils emprunteurs. La mÃ©thode diffÃ©rentielle peut conduire Ã  des rÃ©sultats sensiblement diffÃ©rents de la mÃ©thode classique. Seule votre banque peut confirmer la mÃ©thode retenue pour votre dossier.
</footer>
</main>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SIMULATEUR CRÃ‰DIT IMMOBILIER
//  Calculs rigoureux :
//  - TAEG sur cashflows rÃ©els (valide avec assurance dÃ©croissante)
//  - CircularitÃ© frais de garantie rÃ©solue par formule fermÃ©e
//  - Charges existantes dans le taux d'endettement
//  - MÃ©thode classique vs diffÃ©rentielle pour revenus fonciers
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

'use strict';

// â”€â”€â”€ DOM helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const el = id => document.getElementById(id);

// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let scheduleRows = [];
let amortView    = 'annuel';
let rentalMethod = 'classic';  // 'classic' | 'diff'
let notaryMode   = 'rate';     // 'rate' | 'amount'
let chartBar = null, chartLine = null;

// â”€â”€â”€ Formatters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const fmtEUR = n =>
  Number.isFinite(n)
    ? new Intl.NumberFormat('fr-FR', { maximumFractionDigits: 0 }).format(Math.round(n)) + ' â‚¬'
    : 'â€”';

const fmtPct = (n, d = 2) =>
  Number.isFinite(n) ? n.toFixed(d) + ' %' : 'â€”';

// â”€â”€â”€ Input helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function num(v) {
  const x = parseFloat(v);
  return Number.isFinite(x) && x >= 0 ? x : 0;
}

function clamp(n, lo, hi) { return Math.max(lo, Math.min(hi, n)); }

/**
 * Synchronise slider â†” input numÃ©rique (bidirectionnel).
 */
function syncSlider(rangeId, numId, decimals) {
  const range = el(rangeId), input = el(numId);
  range.addEventListener('input', () => {
    input.value = parseFloat(range.value).toFixed(decimals);
    compute();
  });
  input.addEventListener('input', () => {
    let v = parseFloat(input.value);
    if (!Number.isFinite(v)) return;
    const lo = parseFloat(range.min), hi = parseFloat(range.max);
    const st = parseFloat(range.step) || 1;
    v = Math.round((clamp(v, lo, hi) - lo) / st) * st + lo;
    input.value = v.toFixed(decimals);
    range.value = v.toFixed(decimals);
    compute();
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FINANCE CORE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/**
 * MensualitÃ© (capital + intÃ©rÃªts) â€” annuitÃ© constante.
 */
function annuityPayment(principal, annualRate, months) {
  if (principal <= 0 || months <= 0) return 0;
  const r = annualRate / 12;
  if (r === 0) return principal / months;
  const pow = Math.pow(1 + r, months);
  return principal * r * pow / (pow - 1);
}

/**
 * Tableau d'amortissement complet.
 * GÃ¨re assurance sur capital initial (constante) OU sur capital restant dÃ» (dÃ©croissante).
 */
function buildSchedule({ principal, annualRate, months, insuranceAnnualRate, insuranceMode }) {
  const r    = annualRate / 12;
  const base = annuityPayment(principal, annualRate, months);
  let crd    = principal;
  const rows = [];
  let totalInterest = 0, totalInsurance = 0;

  for (let m = 1; m <= months; m++) {
    const interest  = crd * r;
    const capital   = Math.max(0, base - interest);
    const insBase   = insuranceMode === 'outstanding' ? crd : principal;
    const insurance = (insBase * insuranceAnnualRate) / 12;

    crd = Math.max(0, crd - capital);
    totalInterest  += interest;
    totalInsurance += insurance;

    rows.push({ month: m, payment: base, capital, interest, insurance, crd, total: base + insurance });
    if (crd < 0.01) break;
  }
  return { rows, totalInterest, totalInsurance };
}

/**
 * IRR mensuel par bissection sur cashflows rÃ©els.
 *
 * cashflows[0]  = montant net reÃ§u par l'emprunteur Ã  t=0 (POSITIF)
 * cashflows[t>0]= sorties mensuelles (NÃ‰GATIF)
 *
 * Utiliser les flux rÃ©els rend le calcul valide mÃªme avec
 * une assurance dÃ©croissante (flux non constants).
 */
function solveMonthlyIRR(cashflows) {
  if (!cashflows || cashflows.length < 2) return 0;
  const npv = i => cashflows.reduce((s, cf, t) => s + cf / Math.pow(1 + i, t), 0);

  let lo = -0.99, hi = 1.0;
  let fLo = npv(lo), fHi = npv(hi);
  for (let g = 0; fLo * fHi > 0 && g < 60 && hi < 200; g++) { hi *= 2; fHi = npv(hi); }
  if (fLo * fHi > 0) return 0;

  for (let k = 0; k < 140; k++) {
    const mid = (lo + hi) / 2, fMid = npv(mid);
    if (fLo * fMid <= 0) { hi = mid; fHi = fMid; }
    else                  { lo = mid; fLo = fMid; }
  }
  return (lo + hi) / 2;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  READ INPUTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function readInputs() {
  const propertyPrice = num(el('propertyPrice').value);
  const agencyFees    = num(el('agencyFees').value);
  const works         = num(el('works').value);

  const notaryFees = notaryMode === 'amount'
    ? num(el('notaryAmount').value)
    : propertyPrice * num(el('notaryRateNum').value) / 100;

  const downPayment    = num(el('downPayment').value);
  const loanYears      = clamp(num(el('loanYearsNum').value), 5, 25);
  const annualRate     = clamp(num(el('interestRateNum').value), 0.01, 25) / 100;
  const insuranceRate  = clamp(num(el('insuranceRateNum').value), 0, 10) / 100;
  const insuranceMode  = el('insuranceMode').value;
  const fileFees       = num(el('fileFees').value);
  const guaranteePct   = clamp(num(el('guaranteeRateNum').value), 0, 10);
  const brokerFees     = num(el('brokerFees').value);
  const financeFees    = el('financeLoanFees').checked;
  const income1        = num(el('income1').value);
  const income2        = num(el('income2').value);
  const rentalIncome   = num(el('rentalIncome').value);
  const rentalFactor   = rentalMethod === 'diff' ? 100 : clamp(num(el('rentalFactorNum').value), 0, 100);
  const existingChg    = num(el('existingCharges').value);
  const debtCap        = clamp(num(el('debtCapNum').value), 10, 60) / 100;

  return {
    propertyPrice, agencyFees, works, notaryFees,
    downPayment, loanYears, annualRate, insuranceRate, insuranceMode,
    fileFees, guaranteePct, brokerFees, financeFees,
    income1, income2, rentalIncome, rentalFactor,
    existingChg, debtCap,
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  COMPUTE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function computeResults(s) {
  const months     = Math.round(s.loanYears * 12);
  const budgetTotal = s.propertyPrice + s.notaryFees + s.agencyFees + s.works;
  const guaranteeRate  = s.guaranteePct / 100;
  const fixedLoanFees  = s.fileFees + s.brokerFees;

  // â”€â”€ Capital & frais : rÃ©solution de la circularitÃ© garantie â”€â”€
  //
  // Si les frais sont financÃ©s dans le prÃªt :
  //   capital = (besoin_hors_garantie) / (1 - taux_garantie)
  //   formule fermÃ©e Ã©vitant la circularitÃ©
  //
  let principal, guaranteeFees, totalLoanFees, feesFinancedAmt;

  if (s.financeFees) {
    const baseNeed = Math.max(0, budgetTotal + fixedLoanFees - s.downPayment);
    principal       = guaranteeRate < 1
      ? Math.max(0, baseNeed / (1 - guaranteeRate))
      : Math.max(0, baseNeed);
    guaranteeFees   = principal * guaranteeRate;
    totalLoanFees   = fixedLoanFees + guaranteeFees;
    feesFinancedAmt = totalLoanFees;
  } else {
    const baseCapital = Math.max(0, budgetTotal - s.downPayment);
    guaranteeFees     = baseCapital * guaranteeRate;
    totalLoanFees     = fixedLoanFees + guaranteeFees;
    principal         = baseCapital;
    feesFinancedAmt   = 0;
  }
  principal = Math.max(0, principal);

  // Apport minimum conseillÃ©
  const minDown = s.notaryFees + s.agencyFees + (s.financeFees ? 0 : totalLoanFees);

  // â”€â”€ Amortissement â”€â”€
  const sched = buildSchedule({
    principal,
    annualRate:          s.annualRate,
    months,
    insuranceAnnualRate: s.insuranceRate,
    insuranceMode:       s.insuranceMode,
  });
  scheduleRows = sched.rows;

  const m1         = sched.rows[0] || {};
  const monthly1   = m1.total   || 0;
  const basePaymt1 = m1.payment || 0;
  const insurance1 = m1.insurance || 0;

  const totalInterest  = sched.totalInterest;
  const totalInsurance = sched.totalInsurance;
  const totalPaid      = sched.rows.reduce((a, r) => a + r.total, 0);
  const creditCost     = totalInterest + totalInsurance + totalLoanFees;

  // â”€â”€ Revenus & endettement â”€â”€
  let incomeUsed, chargesUsed;
  if (rentalMethod === 'diff') {
    // MÃ©thode diffÃ©rentielle : loyers dÃ©duits des charges existantes
    const netExisting = Math.max(0, s.existingChg - s.rentalIncome);
    incomeUsed  = s.income1 + s.income2;
    chargesUsed = netExisting + monthly1;
  } else {
    // MÃ©thode classique : loyers pondÃ©rÃ©s ajoutÃ©s aux revenus
    const rentalWeighted = s.rentalIncome * (s.rentalFactor / 100);
    incomeUsed  = s.income1 + s.income2 + rentalWeighted;
    chargesUsed = s.existingChg + monthly1;
  }

  const debtRatio      = incomeUsed > 0 ? chargesUsed / incomeUsed : 0;
  const maxMonthlyDebt = incomeUsed * s.debtCap;
  const remainCapacity = Math.max(0, maxMonthlyDebt - chargesUsed);
  const rav            = Math.max(0, incomeUsed - chargesUsed);

  // â”€â”€ TAEG sur cashflows rÃ©els â”€â”€
  // t=0 : emprunteur reÃ§oit capital net (frais comptant dÃ©duits si non financÃ©s)
  // t>0 : emprunteur verse mensualitÃ© rÃ©elle (base + assurance du mois t)
  const netReceived = s.financeFees ? principal : principal - totalLoanFees;
  const cashflows   = [netReceived, ...sched.rows.map(r => -(r.total))];
  const irrM        = solveMonthlyIRR(cashflows);
  const taeg        = (Math.pow(1 + irrM, 12) - 1) * 100;

  // â”€â”€ Alertes â”€â”€
  const alerts = [];
  if (s.propertyPrice > 0 && s.downPayment < s.notaryFees) {
    alerts.push({ type: 'bad', msg: `Apport (${fmtEUR(s.downPayment)}) infÃ©rieur aux frais de notaire estimÃ©s (${fmtEUR(s.notaryFees)}). Les banques exigent gÃ©nÃ©ralement que l'apport couvre au minimum les frais de notaire.` });
  } else if (s.downPayment < minDown) {
    alerts.push({ type: 'warn', msg: `Apport potentiellement insuffisant. Apport minimum conseillÃ© pour couvrir tous les frais : ${fmtEUR(minDown)}.` });
  }
  if (incomeUsed <= 0) {
    alerts.push({ type: 'warn', msg: 'Renseignez au moins un revenu pour obtenir un taux d\'endettement calculÃ©.' });
  }
  if (s.annualRate < 0.005) {
    alerts.push({ type: 'warn', msg: 'Taux nominal trÃ¨s faible (< 0.5%). VÃ©rifiez la saisie.' });
  }

  return {
    months, budgetTotal, principal, totalLoanFees, feesFinancedAmt, guaranteeFees, minDown,
    monthly1, basePaymt1, insurance1,
    totalInterest, totalInsurance, totalPaid, creditCost,
    incomeUsed, chargesUsed, debtRatio, remainCapacity, rav,
    taeg, alerts,
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render(s, r) {

  // KPIs
  el('kpiMonthly').textContent      = r.principal > 0 ? fmtEUR(r.monthly1) : 'â€”';
  el('kpiMonthlySplit').textContent = r.principal > 0
    ? `CrÃ©dit ${fmtEUR(r.basePaymt1)} + assurance ${fmtEUR(r.insurance1)}`
    : 'Aucun emprunt nÃ©cessaire';

  const debtPct = r.debtRatio * 100;
  el('kpiDebt').textContent     = r.incomeUsed > 0 ? fmtPct(debtPct, 1) : 'â€”';
  el('kpiCapacity').textContent = r.incomeUsed > 0
    ? `Restant Ã  ${fmtPct(s.debtCap * 100, 0)} : ${fmtEUR(r.remainCapacity)}/mois`
    : `Seuil cible : ${fmtPct(s.debtCap * 100, 0)}`;

  el('kpiBudget').textContent  = fmtEUR(r.budgetTotal);
  el('kpiLoan').textContent    = r.principal > 0 ? fmtEUR(r.principal) : 'â€”';
  el('kpiLoanNote').textContent = s.financeFees
    ? `Dont ${fmtEUR(r.totalLoanFees)} de frais financÃ©s`
    : 'Frais de crÃ©dit couverts par l\'apport';

  // BanniÃ¨re
  const banner = el('banner');
  banner.className = 'banner';
  if (r.incomeUsed <= 0) {
    banner.textContent = 'â³ Renseignez vos revenus pour Ã©valuer la faisabilitÃ©.';
  } else if (r.principal <= 0) {
    banner.classList.add('ok');
    banner.textContent = 'âœ“ Apport suffisant â€” aucun emprunt nÃ©cessaire.';
  } else if (debtPct <= s.debtCap * 100 - 2) {
    banner.classList.add('ok');
    banner.textContent = `âœ“ Endettement confortable : ${fmtPct(debtPct, 1)} â€” sous le seuil de ${fmtPct(s.debtCap * 100, 0)}.`;
  } else if (debtPct <= s.debtCap * 100) {
    banner.classList.add('warn');
    banner.textContent = `âš  Endettement limite : ${fmtPct(debtPct, 1)} â€” proche du seuil. FaisabilitÃ© dÃ©pend du profil bancaire.`;
  } else {
    banner.classList.add('bad');
    banner.textContent = `âœ— Endettement trop Ã©levÃ© : ${fmtPct(debtPct, 1)} dÃ©passe le seuil HCSF (${fmtPct(s.debtCap * 100, 0)}). Augmentez l'apport, la durÃ©e ou rÃ©duisez le montant empruntÃ©.`;
  }

  // DÃ©tails
  el('dProperty').textContent   = fmtEUR(s.propertyPrice);
  el('dNotary').textContent     = fmtEUR(s.notaryFees);
  el('dExtras').textContent     = fmtEUR(s.agencyFees + s.works);
  el('dBudget').innerHTML       = `<strong>${fmtEUR(r.budgetTotal)}</strong>`;
  el('dDown').textContent       = fmtEUR(s.downPayment);
  el('dLoanFees').textContent   = fmtEUR(r.totalLoanFees);
  el('dFeesFinanced').textContent = s.financeFees
    ? fmtEUR(r.feesFinancedAmt) : '0 â‚¬ (payÃ©s comptant)';
  el('dLoan').innerHTML         = `<strong>${fmtEUR(r.principal)}</strong>`;
  el('dInterest').textContent   = fmtEUR(r.totalInterest);
  el('dInsurance').textContent  = fmtEUR(r.totalInsurance);
  el('dCreditCost').textContent = fmtEUR(r.creditCost);
  el('dTotalPaid').textContent  = fmtEUR(r.totalPaid);
  el('dTaeg').textContent       = r.principal > 0 ? fmtPct(r.taeg, 2) : 'â€”';
  el('dMinDown').textContent    = fmtEUR(r.minDown);
  el('dRav').textContent        = r.incomeUsed > 0 ? fmtEUR(r.rav) + '/mois' : 'â€”';
  el('dCapacity').textContent   = r.incomeUsed > 0 ? fmtEUR(r.remainCapacity) + '/mois' : 'â€”';

  // Alertes
  const zone = el('alertZone');
  zone.innerHTML = '';
  r.alerts.forEach(a => {
    const d = document.createElement('div');
    d.className = `alert-box ${a.type}`;
    d.innerHTML = `<span class="ai">${a.type === 'bad' ? 'âœ—' : 'âš '}</span><span>${a.msg}</span>`;
    zone.appendChild(d);
  });

  // Notaire estimate
  if (notaryMode === 'rate') {
    el('notaryEstimate').textContent = `Estimation : ${fmtEUR(s.notaryFees)} pour ce bien`;
  }

  // Apport hint
  el('downHint').textContent =
    `Frais de notaire : ${fmtEUR(s.notaryFees)} Â· Frais de crÃ©dit : ${fmtEUR(r.totalLoanFees)} Â· Apport minimum conseillÃ© : ${fmtEUR(r.minDown)}`;

  // Charts
  renderBarChart(r.principal, r.totalInterest, r.totalInsurance, r.totalLoanFees);
  renderLineChart(scheduleRows);
  renderAmortTable();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  CHARTS  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderBarChart(capital, interest, insurance, fees) {
  const ctx = el('chartBar').getContext('2d');
  if (chartBar) { chartBar.destroy(); chartBar = null; }
  chartBar = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Capital remboursÃ©', 'IntÃ©rÃªts', 'Assurance', 'Frais de crÃ©dit'],
      datasets: [{ data: [capital, interest, insurance, fees],
        backgroundColor: ['#1e3a5f', '#c0392b', '#d97706', '#64748b'],
        borderRadius: 4, borderWidth: 0 }],
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false },
        tooltip: { callbacks: { label: c => ' ' + fmtEUR(c.raw) } } },
      scales: {
        y: { grid: { color: '#f0ece4' },
          ticks: { callback: v => new Intl.NumberFormat('fr-FR', { notation: 'compact' }).format(v) + ' â‚¬', font: { size: 10 } } },
        x: { grid: { display: false }, ticks: { font: { size: 11 } } },
      },
    },
  });
}

function renderLineChart(rows) {
  const ctx = el('chartLine').getContext('2d');
  if (chartLine) { chartLine.destroy(); chartLine = null; }
  if (!rows.length) return;

  const yearCount = Math.ceil(rows.length / 12);
  const years = [], crds = [], cumCap = [];
  let cumC = 0;

  for (let y = 0; y < yearCount; y++) {
    const slice = rows.slice(y * 12, (y + 1) * 12);
    cumC += slice.reduce((s, r) => s + r.capital, 0);
    years.push(`A${y + 1}`);
    crds.push(Math.round(slice[slice.length - 1].crd));
    cumCap.push(Math.round(cumC));
  }

  chartLine = new Chart(ctx, {
    type: 'line',
    data: {
      labels: years,
      datasets: [
        { label: 'Capital restant dÃ»', data: crds,
          borderColor: '#c0392b', backgroundColor: 'rgba(192,57,43,.08)',
          fill: true, tension: 0.3, pointRadius: 2 },
        { label: 'Capital remboursÃ© (cumulÃ©)', data: cumCap,
          borderColor: '#16a34a', backgroundColor: 'rgba(22,163,74,.06)',
          fill: true, tension: 0.3, pointRadius: 2, borderDash: [4, 3] },
      ],
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { labels: { font: { size: 11 }, boxWidth: 14 } },
        tooltip: { callbacks: { label: c => ' ' + fmtEUR(c.raw) } },
      },
      scales: {
        y: { grid: { color: '#f0ece4' },
          ticks: { callback: v => new Intl.NumberFormat('fr-FR', { notation: 'compact' }).format(v) + 'â‚¬', font: { size: 10 } } },
        x: { grid: { display: false }, ticks: { font: { size: 10 }, maxTicksLimit: 13 } },
      },
    },
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  AMORT TABLE  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderAmortTable() {
  const tbody = el('amortBody');
  tbody.innerHTML = '';
  if (!scheduleRows.length) return;

  if (amortView === 'mensuel') {
    scheduleRows.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>Mois ${r.month}</td><td>${fmtEUR(r.total)}</td><td>${fmtEUR(r.capital)}</td><td>${fmtEUR(r.interest)}</td><td>${fmtEUR(r.insurance)}</td><td>${fmtEUR(r.crd)}</td>`;
      tbody.appendChild(tr);
    });
  } else {
    const years = Math.ceil(scheduleRows.length / 12);
    for (let y = 0; y < years; y++) {
      const sl = scheduleRows.slice(y * 12, (y + 1) * 12);
      const tr = document.createElement('tr');
      tr.className = 'year-row';
      tr.innerHTML = `<td>AnnÃ©e ${y + 1}</td><td>${fmtEUR(sl.reduce((s, r) => s + r.total, 0))}</td><td>${fmtEUR(sl.reduce((s, r) => s + r.capital, 0))}</td><td>${fmtEUR(sl.reduce((s, r) => s + r.interest, 0))}</td><td>${fmtEUR(sl.reduce((s, r) => s + r.insurance, 0))}</td><td>${fmtEUR(sl[sl.length - 1].crd)}</td>`;
      tbody.appendChild(tr);
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  CSV  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function exportCsv() {
  if (!scheduleRows.length) return;
  const lines = ['Mois;MensualitÃ© totale;Capital;IntÃ©rÃªts;Assurance;Capital restant dÃ»'];
  scheduleRows.forEach(r => lines.push(
    [r.month, Math.round(r.total), Math.round(r.capital),
     Math.round(r.interest), Math.round(r.insurance), Math.round(r.crd)].join(';')
  ));
  const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href = url; a.download = 'amortissement.csv';
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  MAIN COMPUTE  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function compute() {
  const s = readInputs();
  const r = computeResults(s);
  render(s, r);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BINDINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Sliders synchronisÃ©s
syncSlider('notaryRate',    'notaryRateNum',    1);
syncSlider('loanYears',     'loanYearsNum',     0);
syncSlider('interestRate',  'interestRateNum',  2);
syncSlider('insuranceRate', 'insuranceRateNum', 2);
syncSlider('guaranteeRate', 'guaranteeRateNum', 1);
syncSlider('rentalFactor',  'rentalFactorNum',  0);
syncSlider('debtCap',       'debtCapNum',       1);

// Champs numÃ©riques libres
[
  'propertyPrice', 'agencyFees', 'works', 'downPayment', 'notaryAmount',
  'fileFees', 'brokerFees', 'income1', 'income2', 'rentalIncome', 'existingCharges',
].forEach(id => el(id).addEventListener('input', compute));

// Select & checkbox
el('insuranceMode').addEventListener('change', compute);
el('financeLoanFees').addEventListener('change', compute);

// Toggle frais de notaire
function setNotaryMode(mode, preset, rateVal) {
  notaryMode = mode;
  el('notaryRateWrap').classList.toggle('hidden', mode === 'amount');
  el('notaryAmountWrap').classList.toggle('hidden', mode !== 'amount');
  ['btnAnc', 'btnNeuf', 'btnMontant'].forEach(id => el(id).classList.remove('active'));
  el(preset).classList.add('active');
  if (rateVal !== undefined) {
    el('notaryRate').value    = rateVal;
    el('notaryRateNum').value = rateVal;
  }
  compute();
}
el('btnAnc').addEventListener('click',     () => setNotaryMode('rate', 'btnAnc', 7.5));
el('btnNeuf').addEventListener('click',    () => setNotaryMode('rate', 'btnNeuf', 2.5));
el('btnMontant').addEventListener('click', () => setNotaryMode('amount', 'btnMontant'));

// Toggle mÃ©thode revenus fonciers
el('methodClassic').addEventListener('click', () => {
  rentalMethod = 'classic';
  el('methodClassic').classList.add('active');
  el('methodDiff').classList.remove('active');
  el('methodClassicInfo').classList.remove('hidden');
  el('methodDiffInfo').classList.add('hidden');
  compute();
});
el('methodDiff').addEventListener('click', () => {
  rentalMethod = 'diff';
  el('methodDiff').classList.add('active');
  el('methodClassic').classList.remove('active');
  el('methodDiffInfo').classList.remove('hidden');
  el('methodClassicInfo').classList.add('hidden');
  compute();
});

// Vue amortissement
el('btnAnnuel').addEventListener('click', () => {
  amortView = 'annuel';
  el('btnAnnuel').classList.add('active');
  el('btnMensuel').classList.remove('active');
  renderAmortTable();
});
el('btnMensuel').addEventListener('click', () => {
  amortView = 'mensuel';
  el('btnMensuel').classList.add('active');
  el('btnAnnuel').classList.remove('active');
  renderAmortTable();
});

el('btnCsv').addEventListener('click', exportCsv);

// Initialisation
compute();
</script>
</body>
</html>
